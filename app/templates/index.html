{% extends "base.html" %}

{% block title %}{{ app_name or 'Prototipo_chatbot' }} - Inicio{% endblock %}

{% block extra_head %}
<style>
    :root {
        --primary-color: #0d6efd;
        --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .hero-section {
        background: var(--gradient-primary);
        border-radius: 15px;
        position: relative;
        overflow: hidden;
    }
    
    .card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        transition: all 0.3s ease;
    }
    
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 1rem 3rem rgba(0, 0, 0, 0.175);
    }
    
    .icon-circle {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
    }
    
    .btn {
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn:hover {
        transform: translateY(-1px);
    }
    
    .status-item {
        padding: 0.5rem 0;
        border-bottom: 1px solid #f8f9fa;
    }
    
    .status-item:last-child {
        border-bottom: none;
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="row">
    <div class="col-12">
        <div class="hero-section text-white p-5 rounded-3 mb-5">
            <div class="container text-center">
                <h1 class="display-4 fw-bold mb-3">
                    <i class="fas fa-robot me-3"></i>
                    {{ app_name or 'Prototipo_chatbot' }}
                </h1>
                <p class="lead mb-4">{{ app_description or 'Sistema de Chatbot RAG para Administraciones Locales' }}</p>
                {% if app_version %}
                <p class="mb-4">
                    <span class="badge bg-light text-dark fs-6">
                        <i class="fas fa-tag me-1"></i>Versi√≥n {{ app_version }}
                    </span>
                </p>
                {% endif %}
                <div class="d-flex justify-content-center gap-3">
                    <a href="/chat" class="btn btn-light btn-lg">
                        <i class="fas fa-comments me-2"></i>
                        Iniciar Chat
                    </a>
                    <a href="/comparador" class="btn btn-outline-light btn-lg">
                        <i class="fas fa-balance-scale me-2"></i>
                        Ver Comparador
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Features Section -->
    <div class="col-lg-8">
        <h2 class="mb-4">
            <i class="fas fa-star me-2 text-primary"></i>
            Caracter√≠sticas Principales
        </h2>
        
        <div class="row g-4">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="icon-circle bg-primary text-white me-3">
                                <i class="fas fa-search"></i>
                            </div>
                            <h5 class="card-title mb-0">RAG Avanzado</h5>
                        </div>
                        <p class="card-text">
                            Recuperaci√≥n aumentada desde m√∫ltiples fuentes: documentos, APIs, bases de datos y p√°ginas web.
                        </p>
                        <div class="d-flex gap-2">
                            <span class="badge bg-primary">FAISS</span>
                            <span class="badge bg-success">ChromaDB</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="icon-circle bg-success text-white me-3">
                                <i class="fas fa-brain"></i>
                            </div>
                            <h5 class="card-title mb-0">Modelos Duales</h5>
                        </div>
                        <p class="card-text">
                            Comparaci√≥n directa entre modelos locales (Ollama) y modelos en la nube (OpenAI).
                        </p>
                        <div class="d-flex gap-2">
                            <span class="badge bg-warning">Local</span>
                            <span class="badge bg-info">OpenAI</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="icon-circle bg-warning text-white me-3">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <h5 class="card-title mb-0">Seguridad Local</h5>
                        </div>
                        <p class="card-text">
                            Cumplimiento con ENS y CCN-TEC 014. Los datos sensibles nunca salen del servidor local.
                        </p>
                        <div class="d-flex gap-2">
                            <span class="badge bg-success">ENS</span>
                            <span class="badge bg-primary">CCN-TEC</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="icon-circle bg-info text-white me-3">
                                <i class="fas fa-cogs"></i>
                            </div>
                            <h5 class="card-title mb-0">Configuraci√≥n Flexible</h5>
                        </div>
                        <p class="card-text">
                            Ingesta configurable desde documentos, APIs REST, bases de datos y archivos Excel/CSV.
                        </p>
                        <div class="d-flex gap-2">
                            <span class="badge bg-secondary">PDF</span>
                            <span class="badge bg-secondary">API</span>
                            <span class="badge bg-secondary">DB</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- System Status -->
    <div class="col-lg-4">
        <h2 class="mb-4">
            <i class="fas fa-heartbeat me-2 text-success"></i>
            Estado del Sistema
        </h2>
        
        <div class="card">
            <div class="card-header bg-light">
                <h6 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Estado Actual
                </h6>
            </div>
            <div class="card-body">
                <div class="status-item d-flex justify-content-between align-items-center mb-3">
                    <span>
                        <i class="fas fa-server me-2"></i>
                        Servidor Flask
                    </span>
                    <span class="badge bg-success">
                        <i class="fas fa-check-circle me-1"></i>Activo
                    </span>
                </div>
                
                <div class="status-item d-flex justify-content-between align-items-center mb-3">
                    <span>
                        <i class="fas fa-database me-2"></i>
                        Vector Store
                    </span>
                    <span class="badge bg-warning" id="vectorstore-status">
                        <i class="fas fa-clock me-1"></i>Verificando...
                    </span>
                </div>
                
                <div class="status-item d-flex justify-content-between align-items-center mb-3">
                    <span>
                        <i class="fas fa-robot me-2"></i>
                        Modelos Locales
                    </span>
                    <span class="badge bg-warning" id="local-models-status">
                        <i class="fas fa-clock me-1"></i>Verificando...
                    </span>
                </div>
                
                <div class="status-item d-flex justify-content-between align-items-center mb-3">
                    <span>
                        <i class="fas fa-cloud me-2"></i>
                        OpenAI API
                    </span>
                    <span class="badge bg-secondary" id="openai-status">
                        <i class="fas fa-times me-1"></i>No configurado
                    </span>
                </div>
                
                <hr>
                
                <div class="text-center">
                    <button class="btn btn-outline-primary btn-sm" onclick="checkIndexSystemStatus()">
                        <i class="fas fa-sync-alt me-1"></i>
                        Actualizar Estado
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="card mt-4">
            <div class="card-header bg-light">
                <h6 class="mb-0">
                    <i class="fas fa-bolt me-2"></i>
                    Acciones R√°pidas
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="/chat" class="btn btn-primary">
                        <i class="fas fa-comments me-2"></i>
                        Abrir Chat
                    </a>
                    <button class="btn btn-success" onclick="showComingSoon('Configuraci√≥n de Fuentes')">
                        <i class="fas fa-cog me-2"></i>
                        Configurar Fuentes
                    </button>
                    <button class="btn btn-info" onclick="showComingSoon('Panel de Administraci√≥n')">
                        <i class="fas fa-user-shield me-2"></i>
                        Panel Admin
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Section -->
<div class="row mt-5">
    <div class="col-12">
        <h2 class="mb-4">
            <i class="fas fa-chart-line me-2 text-info"></i>
            Estad√≠sticas del Sistema
        </h2>
        
        <div class="row g-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-file-alt fa-2x text-primary mb-3"></i>
                        <h4 class="card-title" id="documents-count">0</h4>
                        <p class="card-text text-muted">Documentos Indexados</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-puzzle-piece fa-2x text-success mb-3"></i>
                        <h4 class="card-title" id="fragments-count">0</h4>
                        <p class="card-text text-muted">Fragmentos RAG</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-comments fa-2x text-warning mb-3"></i>
                        <h4 class="card-title" id="queries-count">0</h4>
                        <p class="card-text text-muted">Consultas Realizadas</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-tachometer-alt fa-2x text-info mb-3"></i>
                        <h4 class="card-title" id="avg-response-time">0.0</h4>
                        <p class="card-text text-muted">Tiempo Respuesta (s)</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// =============================================================================
// FUNCIONES AUXILIARES
// =============================================================================

function showComingSoon(feature) {
    alert(feature + ' se implementar√° en el siguiente paso del desarrollo.');
}

function updateIndexStatus(elementId, status, text) {
    const element = document.getElementById(elementId);
    if (!element) {
        console.warn(`Element with id '${elementId}' not found`);
        return;
    }
    
    // Remover clases anteriores
    element.classList.remove('bg-success', 'bg-warning', 'bg-danger', 'bg-secondary');
    
    // A√±adir nueva clase
    const statusClasses = {
        'success': 'bg-success',
        'warning': 'bg-warning', 
        'danger': 'bg-danger',
        'secondary': 'bg-secondary'
    };
    
    element.classList.add(statusClasses[status] || 'bg-secondary');
    
    // Actualizar icono y texto
    const icons = {
        'success': 'fa-check-circle',
        'warning': 'fa-exclamation-triangle',
        'danger': 'fa-times-circle',
        'secondary': 'fa-times'
    };
    
    element.innerHTML = `<i class="fas ${icons[status] || 'fa-question-circle'} me-1"></i>${text}`;
    
    console.log(`Updated ${elementId}: ${status} - ${text}`);
}

async function updateStatistics(healthData) {
    try {
        // Intentar obtener estad√≠sticas del endpoint /ajax/quick-stats
        let stats = null;
        
        try {
            const statsResponse = await fetch('/ajax/quick-stats');
            if (statsResponse.ok) {
                stats = await statsResponse.json();
            }
        } catch (e) {
            console.log('No stats endpoint available, using health data');
            stats = healthData;
        }
        
        // Actualizar contadores (valores por defecto si no hay datos)
        const documentsCount = document.getElementById('documents-count');
        const fragmentsCount = document.getElementById('fragments-count');
        const queriesCount = document.getElementById('queries-count');
        const avgResponseTime = document.getElementById('avg-response-time');
        
        if (documentsCount) {
            documentsCount.textContent = stats?.documents || '0';
        }
        if (fragmentsCount) {
            // Si no hay fragmentos espec√≠ficos, usar documents como estimaci√≥n
            fragmentsCount.textContent = stats?.fragments || stats?.documents || '0';
        }
        if (queriesCount) {
            queriesCount.textContent = stats?.queries || '0';
        }
        if (avgResponseTime) {
            avgResponseTime.textContent = stats?.avg_response_time ? 
                stats.avg_response_time.toFixed(1) : '0.0';
        }
        
    } catch (error) {
        console.error('Error updating statistics:', error);
    }
}

// =============================================================================
// FUNCIONES PRINCIPALES
// =============================================================================

// Funci√≥n espec√≠fica para el bot√≥n de la p√°gina index
function checkIndexSystemStatus() {
    console.log('üîò Button clicked: checkIndexSystemStatus');
    checkIndexPageStatus(); // Llamar a la funci√≥n espec√≠fica del index
}

// ‚úÖ FUNCI√ìN PRINCIPAL CORREGIDA - AL NIVEL GLOBAL
async function checkIndexPageStatus() {
    console.log('üîç Index: Checking system status...');
    
    try {
        // Mostrar estado "verificando..." en todos los elementos
        updateIndexStatus('vectorstore-status', 'warning', 'Verificando...');
        updateIndexStatus('local-models-status', 'warning', 'Verificando...');
        updateIndexStatus('openai-status', 'warning', 'Verificando...');
        
        // ‚úÖ CORRECCI√ìN: Usar /api/status en lugar de /health
        const response = await fetch('/api/status');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('üìä Index: System status response:', data);
        
        // ‚úÖ ACTUALIZAR Vector Store usando datos reales
        if (data.services && data.services.rag) {
            const ragStatus = data.services.rag.status;
            const totalDocs = data.services.rag.total_documents || 0;
            
            if (ragStatus === 'healthy' && totalDocs > 0) {
                updateIndexStatus('vectorstore-status', 'success', `${totalDocs} documentos`);
            } else if (ragStatus === 'warning') {
                updateIndexStatus('vectorstore-status', 'warning', 'Sin documentos');
            } else {
                updateIndexStatus('vectorstore-status', 'danger', 'Error');
            }
        } else {
            updateIndexStatus('vectorstore-status', 'danger', 'No disponible');
        }
        
        // ‚úÖ ACTUALIZAR Modelos Locales (Ollama) usando datos reales
        if (data.services && data.services.llm && data.services.llm.providers_available) {
            const ollamaAvailable = data.services.llm.providers_available.ollama;
            const ollamaModels = data.services.llm.total_models?.ollama || {};
            const modelCount = Object.keys(ollamaModels).length;
            
            if (ollamaAvailable && modelCount > 0) {
                updateIndexStatus('local-models-status', 'success', `${modelCount} modelos`);
            } else if (ollamaAvailable) {
                updateIndexStatus('local-models-status', 'warning', 'Sin modelos');
            } else {
                updateIndexStatus('local-models-status', 'danger', 'No disponible');
            }
        } else {
            updateIndexStatus('local-models-status', 'danger', 'No configurado');
        }
        
        // ‚úÖ ACTUALIZAR OpenAI API usando datos reales
        if (data.services && data.services.llm && data.services.llm.providers_available) {
            const openaiAvailable = data.services.llm.providers_available.openai;
            const openaiModels = data.services.llm.total_models?.openai || {};
            const modelCount = Object.keys(openaiModels).length;
            
            if (openaiAvailable && modelCount > 0) {
                updateIndexStatus('openai-status', 'success', `${modelCount} modelos`);
            } else if (openaiAvailable) {
                updateIndexStatus('openai-status', 'warning', 'Configurado');
            } else {
                updateIndexStatus('openai-status', 'secondary', 'No configurado');
            }
        } else {
            updateIndexStatus('openai-status', 'secondary', 'No configurado');
        }
        
        // Actualizar estad√≠sticas
        updateStatistics(data);
        
        console.log('‚úÖ Index: System status check completed successfully');
        
    } catch (error) {
        console.error('‚ùå Index: Error checking system status:', error);
        
        // Mostrar error en todos los componentes
        updateIndexStatus('vectorstore-status', 'danger', 'Error de conexi√≥n');
        updateIndexStatus('local-models-status', 'danger', 'Error de conexi√≥n');
        updateIndexStatus('openai-status', 'danger', 'Error de conexi√≥n');
    }
}

// =============================================================================
// INICIALIZACI√ìN
// =============================================================================

// Verificar estado al cargar la p√°gina - ESPEC√çFICO PARA INDEX
document.addEventListener('DOMContentLoaded', function() {
    // Esperar un poco m√°s para asegurar que base.html termine de cargar
    setTimeout(function() {
        console.log('üè† Index page: Starting system status check...');
        
        // Verificar que los elementos del INDEX existen
        const vectorElement = document.getElementById('vectorstore-status');
        const modelsElement = document.getElementById('local-models-status');
        const openaiElement = document.getElementById('openai-status');
        
        if (vectorElement && modelsElement && openaiElement) {
            console.log('‚úÖ Index status elements found, proceeding with health check');
            
            // ‚úÖ LLAMAR a la funci√≥n (que ya est√° definida al nivel global)
            checkIndexPageStatus();
            
            // Actualizar estado cada 30 segundos SOLO para la p√°gina index
            setInterval(checkIndexPageStatus, 30000);
        } else {
            console.warn('‚ùå Index status elements not found:', {
                vectorstore: !!vectorElement,
                models: !!modelsElement,
                openai: !!openaiElement
            });
        }
    }, 2000); // Delay de 2 segundos para evitar conflictos
});
</script>
{% endblock %}