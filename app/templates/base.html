<!DOCTYPE html>
<html lang="es" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="{% block meta_description %}Sistema de Chatbot RAG para Administraciones Locales - TFM Vicente Caruncho{% endblock %}">
    <meta name="author" content="Vicente Caruncho Ramos">
    <meta name="robots" content="noindex, nofollow">
    
    <title>{% block title %}{{ app_name or 'Prototipo_chatbot' }}{% endblock %}</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🤖</text></svg>">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" 
          integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"
          integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous">
    
    <!-- Custom CSS -->
    <style>
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .visually-hidden-focusable {
            position: absolute !important;
            width: 1px !important;
            height: 1px !important;
            padding: 0 !important;
            margin: -1px !important;
            overflow: hidden !important;
            clip: rect(0, 0, 0, 0) !important;
            white-space: nowrap !important;
            border: 0 !important;
        }
        
        .visually-hidden-focusable:focus {
            position: static !important;
            width: auto !important;
            height: auto !important;
            padding: 0.25rem 0.5rem !important;
            margin: 0 !important;
            overflow: visible !important;
            clip: auto !important;
            white-space: normal !important;
            background-color: #007bff !important;
            color: white !important;
            text-decoration: none !important;
        }
    </style>
    
    <!-- Chart.js (si se necesita) -->
    {% if request.endpoint and ('dashboard' in request.endpoint or 'charts' in request.endpoint) %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js" 
            integrity="sha384-6zzs0l5+yGnBzWIPGSZCgdOW1yN6RL6owbJq0/xCH76d5Qc5P+9YBRwqmq+MfLWa" crossorigin="anonymous"></script>
    {% endif %}
    
    {% block extra_head %}{% endblock %}
</head>
<body class="d-flex flex-column min-vh-100">
    <!-- Skip to main content (accesibilidad) -->
    <a class="visually-hidden-focusable" href="#main-content">Saltar al contenido principal</a>
    
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top shadow-sm" aria-label="Navegación principal">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold d-flex align-items-center" href="/">
                <i class="fas fa-robot me-2" aria-hidden="true"></i>
                <span>{{ app_name or 'Prototipo_chatbot' }}</span>
                {% if app_version %}
                <small class="badge bg-light text-dark ms-2">v{{ app_version }}</small>
                {% endif %}
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Alternar navegación">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'index' }}" 
                           href="/" aria-current="{{ 'page' if request.endpoint == 'index' }}">
                            <i class="fas fa-home me-1" aria-hidden="true"></i>Inicio
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint and 'chat' in request.endpoint }}"
                           href="/chat" aria-current="{{ 'page' if request.endpoint and 'chat' in request.endpoint }}">
                            <i class="fas fa-comments me-1" aria-hidden="true"></i>Chat RAG
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint and 'dashboard' in request.endpoint }}"
                           href="/dashboard" aria-current="{{ 'page' if request.endpoint and 'dashboard' in request.endpoint }}">
                            <i class="fas fa-tachometer-alt me-1" aria-hidden="true"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint and 'comparador' in request.endpoint }}"
                           href="/comparador" aria-current="{{ 'page' if request.endpoint and 'comparador' in request.endpoint }}">
                            <i class="fas fa-balance-scale me-1" aria-hidden="true"></i>Comparador
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" 
                           aria-expanded="false" aria-haspopup="true">
                            <i class="fas fa-cog me-1" aria-hidden="true"></i>Configuración
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#">
                                <i class="fas fa-sliders-h me-2" aria-hidden="true"></i>Configuración General
                            </a></li>
                            <li><a class="dropdown-item" href="/fuentes-datos">
                                <i class="fas fa-upload me-2" aria-hidden="true"></i>Ingesta de Datos
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#">
                                <i class="fas fa-book me-2" aria-hidden="true"></i>Documentación
                            </a></li>
                            <li><a class="dropdown-item" href="#">
                                <i class="fas fa-info-circle me-2" aria-hidden="true"></i>Acerca de
                            </a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" 
                           aria-expanded="false" aria-haspopup="true">
                            <i class="fas fa-link me-1" aria-hidden="true"></i>Endpoints
                        </a>
                        <ul class="dropdown-menu">
                            <li><h6 class="dropdown-header">Estado del Sistema</h6></li>
                            <li><a class="dropdown-item" href="http://localhost:5000/health" target="_blank">
                                <i class="fas fa-heartbeat me-2 text-success" aria-hidden="true"></i>Estado del Sistema
                                <small class="text-muted d-block">/health</small>
                            </a></li>
                            <li><a class="dropdown-item" href="http://localhost:5000/api/status" target="_blank">
                                <i class="fas fa-cog me-2 text-info" aria-hidden="true"></i>API de Estado
                                <small class="text-muted d-block">/api/status</small>
                            </a></li>
                            <li><a class="dropdown-item" href="http://localhost:5000/routes" target="_blank">
                                <i class="fas fa-route me-2 text-warning" aria-hidden="true"></i>Lista de Rutas
                                <small class="text-muted d-block">/routes</small>
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><h6 class="dropdown-header">Endpoints API</h6></li>
                            <li><a class="dropdown-item" href="http://localhost:5000/ajax/quick-stats" target="_blank">
                                <i class="fas fa-chart-bar me-2 text-primary" aria-hidden="true"></i>Estadísticas Rápidas
                                <small class="text-muted d-block">/ajax/quick-stats</small>
                            </a></li>
                        </ul>
                    </li>
                </ul>
                
                <!-- Status indicators -->
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" 
                           aria-expanded="false" aria-label="Estado del sistema">
                            <span class="badge bg-success pulse" id="system-status-indicator">
                                <i class="fas fa-circle me-1" aria-hidden="true"></i>Sistema
                            </span>
                        </a>
                        <div class="dropdown-menu dropdown-menu-end p-3" style="min-width: 320px;">
                            <h6 class="dropdown-header">Estado de Servicios</h6>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span><i class="fas fa-database me-2" aria-hidden="true"></i>Vector Store</span>
                                <span class="badge bg-secondary" id="vectorstore-status-nav">
                                    <i class="fas fa-clock me-1" aria-hidden="true"></i>Verificando...
                                </span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span><i class="fas fa-robot me-2" aria-hidden="true"></i>Modelos Locales</span>
                                <span class="badge bg-secondary" id="local-models-status-nav">
                                    <i class="fas fa-clock me-1" aria-hidden="true"></i>Verificando...
                                </span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span><i class="fas fa-cloud me-2" aria-hidden="true"></i>OpenAI API</span>
                                <span class="badge bg-secondary" id="openai-status-nav">
                                    <i class="fas fa-clock me-1" aria-hidden="true"></i>Verificando...
                                </span>
                            </div>
                            
                            <!-- Estadísticas rápidas -->
                            <hr class="my-2">
                            <h6 class="dropdown-header">Estadísticas</h6>
                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <div class="text-center p-2 bg-light rounded">
                                        <small class="text-muted d-block">Documentos</small>
                                        <strong id="quick-docs-count">-</strong>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="text-center p-2 bg-light rounded">
                                        <small class="text-muted d-block">Consultas</small>
                                        <strong id="quick-queries-count">-</strong>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="text-center p-2 bg-light rounded">
                                        <small class="text-muted d-block">Uptime</small>
                                        <strong id="quick-uptime">-</strong>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="text-center p-2 bg-light rounded">
                                        <small class="text-muted d-block">Resp. Time</small>
                                        <strong id="quick-response-time">-</strong>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-grid">
                                <button class="btn btn-outline-primary btn-sm" id="refresh-system-status" type="button">
                                    <i class="fas fa-sync-alt me-1" aria-hidden="true"></i>Actualizar Estado
                                </button>
                            </div>
                        </div>
                    </li>
                    
                    <!-- Theme toggle -->
                    <li class="nav-item">
                        <button class="nav-link btn btn-link" id="theme-toggle" type="button" 
                                aria-label="Alternar tema claro/oscuro" title="Alternar tema">
                            <i class="fas fa-moon" aria-hidden="true"></i>
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-fill" id="main-content" style="margin-top: 80px;">
        <!-- Loading overlay -->
        <div id="loading-overlay" class="position-fixed top-0 start-0 w-100 h-100 d-none" 
             style="background: rgba(0,0,0,0.5); z-index: 9999;">
            <div class="d-flex justify-content-center align-items-center h-100">
                <div class="text-center text-white">
                    <div class="spinner-border mb-3" role="status" aria-hidden="true"></div>
                    <div>Procesando...</div>
                </div>
            </div>
        </div>
        
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="container-fluid mt-3">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" 
                             role="alert" aria-live="polite">
                            {% set icons = {
                                'error': 'fa-exclamation-triangle',
                                'success': 'fa-check-circle',
                                'warning': 'fa-exclamation-circle',
                                'info': 'fa-info-circle'
                            } %}
                            <i class="fas {{ icons.get(category, 'fa-info-circle') }} me-2" aria-hidden="true"></i>
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- Breadcrumb (opcional) -->
        {% block breadcrumb %}{% endblock %}

        <!-- Page Content -->
        <div class="container-fluid py-3">
            {% block content %}
            <div class="text-center py-5">
                <h1 class="display-4">¡Bienvenido a Prototipo_chatbot!</h1>
                <p class="lead">Sistema RAG para Administraciones Locales</p>
                <p class="text-muted">TFM Vicente Caruncho Ramos - Sistemas Inteligentes UJI</p>
                <div class="mt-4">
                    <a href="/chat" class="btn btn-primary btn-lg me-3">
                        <i class="fas fa-comments me-2"></i>Acceder al Chat RAG
                    </a>
                    <a href="/dashboard" class="btn btn-outline-primary btn-lg me-3">
                        <i class="fas fa-tachometer-alt me-2"></i>Ver Dashboard
                    </a>
                    <a href="/health" class="btn btn-outline-secondary">
                        <i class="fas fa-chart-line me-2"></i>Estado del Sistema
                    </a>
                </div>
            </div>
            {% endblock %}
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-light py-4 mt-auto border-top">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-robot me-2 text-primary" aria-hidden="true"></i>
                        <div>
                            <strong>{{ app_name or 'Prototipo_chatbot' }}</strong>
                            {% if app_version %}<small class="text-muted">v{{ app_version }}</small>{% endif %}
                            <br>
                            <small class="text-muted">{{ app_description or 'Sistema RAG para Administraciones Locales' }}</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 text-md-end">
                    <div class="d-flex flex-wrap justify-content-md-end gap-3 mt-3 mt-md-0">
                        <span class="badge bg-primary" id="footer-vector-store-status">
                            <i class="fas fa-database me-1" aria-hidden="true"></i>
                            <span>Vector Store</span>
                        </span>
                        <span class="badge bg-success" id="footer-model-status">
                            <i class="fas fa-brain me-1" aria-hidden="true"></i>
                            <span>Modelos IA</span>
                        </span>
                    </div>
                    <small class="text-muted d-block mt-2">
                        TFM Vicente Caruncho - Sistemas Inteligentes 2025
                    </small>
                </div>
            </div>
        </div>
    </footer>

    <!-- Toast container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" aria-live="polite" aria-atomic="true">
        <!-- Los toasts se añadirán dinámicamente aquí -->
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" 
            crossorigin="anonymous"></script>
    
    <!-- Page specific scripts -->
    {% block extra_scripts %}{% endblock %}

    <script>
        // Configuración global para JavaScript
        window.PrototipoChatbot = {
            config: {
                baseUrl: window.location.origin,
                currentPage: '{{ request.endpoint or "unknown" }}',
                apiEndpoints: {
                    status: '/health',
                    quickStats: '/ajax/quick-stats',
                    chatQuery: '/api/chat/send',
                    ragSearch: '/api/chat/status'
                }
            },
            user: {
                isAuthenticated: false,
                permissions: []
            }
        };

        // Inicializar aplicación cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Prototipo_chatbot inicializado');
            
            // Configurar tema
            initializeTheme();
            
            // Verificar estado del sistema
            checkSystemStatus();
            
            // Cargar estadísticas rápidas
            loadQuickStats();
        });

        // Gestión de tema claro/oscuro
        function initializeTheme() {
            const themeToggle = document.getElementById('theme-toggle');
            const themeIcon = themeToggle.querySelector('i');
            const htmlElement = document.documentElement;
            
            // Obtener tema guardado o usar preferencia del sistema
            const savedTheme = localStorage.getItem('theme');
            const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            const currentTheme = savedTheme || systemTheme;
            
            // Aplicar tema
            htmlElement.setAttribute('data-bs-theme', currentTheme);
            updateThemeIcon(themeIcon, currentTheme);
            
            // Event listener para toggle
            themeToggle.addEventListener('click', function() {
                const currentTheme = htmlElement.getAttribute('data-bs-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                htmlElement.setAttribute('data-bs-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeIcon(themeIcon, newTheme);
            });
        }

        function updateThemeIcon(icon, theme) {
            icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }

        // Verificación de estado del sistema
        function checkSystemStatus() {
            fetch('/health')
                .then(response => response.json())
                .then(data => {
                    updateStatusIndicators(data);
                })
                .catch(error => {
                    console.warn('Error verificando estado del sistema:', error);
                    updateStatusIndicators({
                        status: 'error'
                    });
                });
        }

        function updateStatusIndicators(status) {
            const statusConfig = {
                'healthy': { class: 'bg-success', icon: 'fa-check-circle', text: 'Activo' },
                'warning': { class: 'bg-warning', icon: 'fa-exclamation-triangle', text: 'Advertencia' },
                'error': { class: 'bg-danger', icon: 'fa-times-circle', text: 'Error' },
                'unknown': { class: 'bg-secondary', icon: 'fa-question-circle', text: 'Desconocido' }
            };

            // Actualizar indicador principal
            const mainIndicator = document.getElementById('system-status-indicator');
            if (mainIndicator) {
                const config = statusConfig[status.status] || statusConfig['unknown'];
                mainIndicator.className = `badge ${config.class} pulse`;
                mainIndicator.innerHTML = `<i class="fas ${config.icon} me-1"></i>Sistema`;
            }

            // Actualizar indicadores específicos si están disponibles en el status
            if (status.components) {
                updateComponentStatus('vectorstore-status-nav', status.components.vector_store);
                updateComponentStatus('local-models-status-nav', status.services?.ollama);
                updateComponentStatus('openai-status-nav', status.services?.openai);
            }
        }

        function updateComponentStatus(elementId, componentStatus) {
            const element = document.getElementById(elementId);
            if (!element) return;

            const statusMap = {
                'available': { class: 'bg-success', icon: 'fa-check-circle', text: 'Disponible' },
                'configured': { class: 'bg-success', icon: 'fa-check-circle', text: 'Configurado' },
                'healthy': { class: 'bg-success', icon: 'fa-check-circle', text: 'Saludable' },
                'warning': { class: 'bg-warning', icon: 'fa-exclamation-triangle', text: 'Advertencia' },
                'error': { class: 'bg-danger', icon: 'fa-times-circle', text: 'Error' },
                'unavailable': { class: 'bg-danger', icon: 'fa-times-circle', text: 'No disponible' }
            };

            const config = statusMap[componentStatus] || { class: 'bg-secondary', icon: 'fa-question-circle', text: 'Desconocido' };
            element.className = `badge ${config.class}`;
            element.innerHTML = `<i class="fas ${config.icon} me-1"></i>${config.text}`;
        }

        // Cargar estadísticas rápidas
        async function loadQuickStats() {
            try {
                const response = await fetch('/ajax/quick-stats');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const stats = await response.json();
                
                // Actualizar elementos de estadísticas rápidas
                const updateElement = (id, value) => {
                    const element = document.getElementById(id);
                    if (element) element.textContent = value;
                };

                updateElement('quick-docs-count', stats.documents || '0');
                updateElement('quick-queries-count', stats.queries || '0');
                updateElement('quick-uptime', formatUptime(stats.uptime || 0));
                updateElement('quick-response-time', `${(stats.avg_response_time || 0).toFixed(1)}s`);
                
            } catch (error) {
                console.warn('Error cargando estadísticas rápidas:', error);
                // Mostrar valores por defecto en caso de error
                ['quick-docs-count', 'quick-queries-count', 'quick-uptime', 'quick-response-time'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.textContent = 'N/A';
                });
            }
        }

        // Formatear uptime en formato legible
        function formatUptime(hours) {
            if (hours < 1) {
                return `${Math.round(hours * 60)}m`;
            } else if (hours < 24) {
                return `${hours.toFixed(1)}h`;
            } else {
                const days = Math.floor(hours / 24);
                const remainingHours = Math.round(hours % 24);
                return `${days}d ${remainingHours}h`;
            }
        }

        // Refresh status button
        document.addEventListener('click', function(e) {
            if (e.target.id === 'refresh-system-status' || e.target.closest('#refresh-system-status')) {
                e.preventDefault();
                const button = document.getElementById('refresh-system-status');
                const originalContent = button.innerHTML;
                
                button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Actualizando...';
                button.disabled = true;
                
                // Actualizar tanto el estado como las estadísticas
                Promise.all([checkSystemStatus(), loadQuickStats()])
                    .finally(() => {
                        setTimeout(() => {
                            button.innerHTML = originalContent;
                            button.disabled = false;
                        }, 1000);
                    });
            }
        });

        // Actualizar estado y estadísticas cada 30 segundos
        setInterval(() => {
            checkSystemStatus();
            loadQuickStats();
        }, 30000);
    </script>
</body>
</html>