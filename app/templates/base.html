<!DOCTYPE html>
<html lang="es" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="{% block meta_description %}Sistema de Chatbot RAG para Administraciones Locales - TFM Vicente Caruncho{% endblock %}">
    <meta name="author" content="Vicente Caruncho Ramos">
    <meta name="robots" content="noindex, nofollow">
    
    <title>{% block title %}{{ app_name or 'Prototipo_chatbot' }}{% endblock %}</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/favicon.ico') if url_for('static', filename='images/favicon.ico') else 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🤖</text></svg>' }}">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" 
          integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"
          integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous">
    
    <!-- Custom CSS -->
    <link href="{{ url_for('static', filename='css/custom.css') }}" rel="stylesheet">
    
    <!-- Chart.js (si se necesita) -->
    {% if 'dashboard' in request.endpoint or 'charts' in request.endpoint %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js" 
            integrity="sha384-6zzs0l5+yGnBzWIPGSZCgdOW1yN6RL6owbJq0/xCH76d5Qc5P+9YBRwqmq+MfLWa" crossorigin="anonymous"></script>
    {% endif %}
    
    {% block extra_head %}{% endblock %}
</head>
<body class="d-flex flex-column min-vh-100">
    <!-- Skip to main content (accesibilidad) -->
    <a class="visually-hidden-focusable" href="#main-content">Saltar al contenido principal</a>
    
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top shadow-sm" aria-label="Navegación principal">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold d-flex align-items-center" href="{{ url_for('main.index') }}">
                <i class="fas fa-robot me-2" aria-hidden="true"></i>
                <span>{{ app_name or 'Prototipo_chatbot' }}</span>
                {% if app_version %}
                <small class="badge bg-light text-dark ms-2">v{{ app_version }}</small>
                {% endif %}
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Alternar navegación">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'main.index' }}" 
                           href="{{ url_for('main.index') }}" aria-current="{{ 'page' if request.endpoint == 'main.index' }}">
                            <i class="fas fa-home me-1" aria-hidden="true"></i>Inicio
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if 'chat' in request.endpoint }}" 
                           href="{{ url_for('chat.chat_index') }}" aria-current="{{ 'page' if 'chat' in request.endpoint }}">
                            <i class="fas fa-comments me-1" aria-hidden="true"></i>Chat RAG
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'main.dashboard' }}" 
                           href="{{ url_for('main.dashboard') }}" aria-current="{{ 'page' if request.endpoint == 'main.dashboard' }}">
                            <i class="fas fa-chart-line me-1" aria-hidden="true"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" 
                           aria-expanded="false" aria-haspopup="true">
                            <i class="fas fa-cog me-1" aria-hidden="true"></i>Sistema
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item {{ 'active' if request.endpoint == 'main.settings' }}" 
                                   href="{{ url_for('main.settings') }}">
                                <i class="fas fa-sliders-h me-2" aria-hidden="true"></i>Configuración
                            </a></li>
                            <li><a class="dropdown-item" href="#" id="ingestion-link">
                                <i class="fas fa-upload me-2" aria-hidden="true"></i>Ingesta de Datos
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item {{ 'active' if request.endpoint == 'main.documentation' }}" 
                                   href="{{ url_for('main.documentation') }}">
                                <i class="fas fa-book me-2" aria-hidden="true"></i>Documentación
                            </a></li>
                            <li><a class="dropdown-item {{ 'active' if request.endpoint == 'main.about' }}" 
                                   href="{{ url_for('main.about') }}">
                                <i class="fas fa-info-circle me-2" aria-hidden="true"></i>Acerca de
                            </a></li>
                        </ul>
                    </li>
                </ul>
                
                <!-- Status indicators -->
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" 
                           aria-expanded="false" aria-label="Estado del sistema">
                            <span class="badge bg-success pulse" id="system-status-indicator">
                                <i class="fas fa-circle me-1" aria-hidden="true"></i>Sistema
                            </span>
                        </a>
                        <div class="dropdown-menu dropdown-menu-end p-3" style="min-width: 300px;">
                            <h6 class="dropdown-header">Estado de Servicios</h6>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span><i class="fas fa-database me-2" aria-hidden="true"></i>Vector Store</span>
                                <span class="badge bg-secondary" id="vectorstore-status-nav">
                                    <i class="fas fa-clock me-1" aria-hidden="true"></i>Verificando...
                                </span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span><i class="fas fa-robot me-2" aria-hidden="true"></i>Modelos Locales</span>
                                <span class="badge bg-secondary" id="local-models-status-nav">
                                    <i class="fas fa-clock me-1" aria-hidden="true"></i>Verificando...
                                </span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span><i class="fas fa-cloud me-2" aria-hidden="true"></i>OpenAI API</span>
                                <span class="badge bg-secondary" id="openai-status-nav">
                                    <i class="fas fa-clock me-1" aria-hidden="true"></i>Verificando...
                                </span>
                            </div>
                            <div class="d-grid">
                                <button class="btn btn-outline-primary btn-sm" id="refresh-system-status" type="button">
                                    <i class="fas fa-sync-alt me-1" aria-hidden="true"></i>Actualizar Estado
                                </button>
                            </div>
                        </div>
                    </li>
                    
                    <!-- Theme toggle -->
                    <li class="nav-item">
                        <button class="nav-link btn btn-link" id="theme-toggle" type="button" 
                                aria-label="Alternar tema claro/oscuro" title="Alternar tema">
                            <i class="fas fa-moon" aria-hidden="true"></i>
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-fill" id="main-content" style="margin-top: 80px;">
        <!-- Loading overlay -->
        <div id="loading-overlay" class="position-fixed top-0 start-0 w-100 h-100 d-none" 
             style="background: rgba(0,0,0,0.5); z-index: 9999;">
            <div class="d-flex justify-content-center align-items-center h-100">
                <div class="text-center text-white">
                    <div class="spinner-border mb-3" role="status" aria-hidden="true"></div>
                    <div>Procesando...</div>
                </div>
            </div>
        </div>
        
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="container-fluid mt-3">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" 
                             role="alert" aria-live="polite">
                            {% set icons = {
                                'error': 'fa-exclamation-triangle',
                                'success': 'fa-check-circle',
                                'warning': 'fa-exclamation-circle',
                                'info': 'fa-info-circle'
                            } %}
                            <i class="fas {{ icons.get(category, 'fa-info-circle') }} me-2" aria-hidden="true"></i>
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- Breadcrumb (opcional) -->
        {% block breadcrumb %}{% endblock %}

        <!-- Page Content -->
        <div class="container-fluid py-3">
            {% block content %}
            <div class="text-center py-5">
                <h1 class="display-4">¡Bienvenido a Prototipo_chatbot!</h1>
                <p class="lead">Sistema RAG para Administraciones Locales</p>
            </div>
            {% endblock %}
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-light py-4 mt-auto border-top">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-robot me-2 text-primary" aria-hidden="true"></i>
                        <div>
                            <strong>{{ app_name or 'Prototipo_chatbot' }}</strong>
                            {% if app_version %}<small class="text-muted">v{{ app_version }}</small>{% endif %}
                            <br>
                            <small class="text-muted">{{ app_description or 'Sistema RAG para Administraciones Locales' }}</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 text-md-end">
                    <div class="d-flex flex-wrap justify-content-md-end gap-3 mt-3 mt-md-0">
                        <span class="badge bg-primary" id="footer-vector-store-status">
                            <i class="fas fa-database me-1" aria-hidden="true"></i>
                            <span>Vector Store</span>
                        </span>
                        <span class="badge bg-success" id="footer-model-status">
                            <i class="fas fa-brain me-1" aria-hidden="true"></i>
                            <span>Modelos IA</span>
                        </span>
                    </div>
                    <small class="text-muted d-block mt-2">
                        TFM Vicente Caruncho - Sistemas Inteligentes {{ current_year or '2025' }}
                    </small>
                </div>
            </div>
        </div>
    </footer>

    <!-- Toast container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" aria-live="polite" aria-atomic="true">
        <!-- Los toasts se añadirán dinámicamente aquí -->
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" 
            crossorigin="anonymous"></script>
    
    <!-- Custom JavaScript -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    
    <!-- Page specific scripts -->
    {% block extra_scripts %}{% endblock %}

    <script>
        // Configuración global para JavaScript
        window.PrototipoChatbot = {
            config: {
                baseUrl: '{{ request.url_root }}',
                currentPage: '{{ request.endpoint }}',
                apiEndpoints: {
                    status: '{{ url_for("api.system_status") }}',
                    chatQuery: '{{ url_for("api.chat_query") }}',
                    ragSearch: '{{ url_for("api.rag_search") }}'
                },
                csrf_token: '{{ csrf_token() if csrf_token else "" }}'
            },
            user: {
                isAuthenticated: false, // En el futuro para autenticación
                permissions: []
            }
        };

        // Inicializar aplicación cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Prototipo_chatbot inicializado');
            
            // Verificar estado del sistema automáticamente
            if (window.prototipoApp && typeof window.prototipoApp.initialize === 'function') {
                window.prototipoApp.initialize();
            }
            
            // Configurar tema
            initializeTheme();
            
            // Verificar estado del sistema
            checkSystemStatus();
        });

        // Gestión de tema claro/oscuro
        function initializeTheme() {
            const themeToggle = document.getElementById('theme-toggle');
            const themeIcon = themeToggle.querySelector('i');
            const htmlElement = document.documentElement;
            
            // Obtener tema guardado o usar preferencia del sistema
            const savedTheme = localStorage.getItem('theme');
            const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            const currentTheme = savedTheme || systemTheme;
            
            // Aplicar tema
            htmlElement.setAttribute('data-bs-theme', currentTheme);
            updateThemeIcon(themeIcon, currentTheme);
            
            // Event listener para toggle
            themeToggle.addEventListener('click', function() {
                const currentTheme = htmlElement.getAttribute('data-bs-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                htmlElement.setAttribute('data-bs-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeIcon(themeIcon, newTheme);
            });
        }

        function updateThemeIcon(icon, theme) {
            icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }

        // Verificación de estado del sistema
        function checkSystemStatus() {
            fetch('{{ url_for("main.ajax_system_health") }}')
                .then(response => response.json())
                .then(data => {
                    updateStatusIndicators(data);
                })
                .catch(error => {
                    console.warn('Error verificando estado del sistema:', error);
                    // Mostrar estado de error
                    updateStatusIndicators({
                        overall: 'error',
                        rag: 'error',
                        llm: 'error',
                        ingestion: 'error'
                    });
                });
        }

        function updateStatusIndicators(status) {
            const statusConfig = {
                'healthy': { class: 'bg-success', icon: 'fa-check-circle', text: 'Activo' },
                'warning': { class: 'bg-warning', icon: 'fa-exclamation-triangle', text: 'Advertencia' },
                'error': { class: 'bg-danger', icon: 'fa-times-circle', text: 'Error' },
                'unknown': { class: 'bg-secondary', icon: 'fa-question-circle', text: 'Desconocido' }
            };

            // Actualizar indicador principal
            const mainIndicator = document.getElementById('system-status-indicator');
            if (mainIndicator) {
                const config = statusConfig[status.overall] || statusConfig['unknown'];
                mainIndicator.className = `badge ${config.class} pulse`;
                mainIndicator.innerHTML = `<i class="fas ${config.icon} me-1"></i>Sistema`;
            }

            // Actualizar indicadores específicos
            const indicators = [
                { id: 'vectorstore-status-nav', key: 'rag' },
                { id: 'local-models-status-nav', key: 'llm' },
                { id: 'openai-status-nav', key: 'llm' }
            ];

            indicators.forEach(({ id, key }) => {
                const element = document.getElementById(id);
                if (element) {
                    const config = statusConfig[status[key]] || statusConfig['unknown'];
                    element.className = `badge ${config.class}`;
                    element.innerHTML = `<i class="fas ${config.icon} me-1"></i>${config.text}`;
                }
            });
        }

        // Refresh status button
        document.addEventListener('click', function(e) {
            if (e.target.id === 'refresh-system-status' || e.target.closest('#refresh-system-status')) {
                e.preventDefault();
                const button = document.getElementById('refresh-system-status');
                const originalContent = button.innerHTML;
                
                button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Actualizando...';
                button.disabled = true;
                
                checkSystemStatus();
                
                setTimeout(() => {
                    button.innerHTML = originalContent;
                    button.disabled = false;
                }, 2000);
            }
        });

        // Actualizar estado cada 30 segundos
        setInterval(checkSystemStatus, 30000);
    </script>
</body>
</html>