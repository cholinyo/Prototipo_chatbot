{% extends "base.html" %}

{% block title %}Chat RAG - {{ app_name }}{% endblock %}

{% block meta_description %}Interfaz de chat con sistema RAG para consultas a administraciones locales{% endblock %}

{% block extra_head %}
<style>
.chat-container {
    height: calc(100vh - 200px);
    min-height: 500px;
}

.messages-container {
    height: calc(100% - 120px);
    overflow-y: auto;
    scroll-behavior: smooth;
}

.message {
    max-width: 85%;
    margin-bottom: 1rem;
    animation: fadeInUp 0.3s ease-out;
}

.message.user {
    margin-left: auto;
}

.message.assistant {
    margin-right: auto;
}

.message-content {
    padding: 0.75rem 1rem;
    border-radius: 1rem;
    word-wrap: break-word;
}

.message.user .message-content {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    border-bottom-right-radius: 0.25rem;
}

.message.assistant .message-content {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    color: #212529;
    border-bottom-left-radius: 0.25rem;
}

[data-bs-theme="dark"] .message.assistant .message-content {
    background: #343a40;
    border-color: #495057;
    color: #f8f9fa;
}

.message-metadata {
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

.typing-indicator {
    display: none;
    align-items: center;
    padding: 0.75rem 1rem;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 1rem;
    margin-bottom: 1rem;
    max-width: 85%;
}

.typing-dots {
    display: flex;
    gap: 0.25rem;
}

.typing-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #6c757d;
    animation: typing 1.4s infinite ease-in-out both;
}

.typing-dot:nth-child(1) { animation-delay: -0.32s; }
.typing-dot:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing {
    0%, 80%, 100% {
        transform: scale(0);
        opacity: 0.5;
    }
    40% {
        transform: scale(1);
        opacity: 1;
    }
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.rag-sources {
    max-height: 200px;
    overflow-y: auto;
}

.comparison-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-top: 1rem;
}

@media (max-width: 768px) {
    .comparison-container {
        grid-template-columns: 1fr;
    }
    
    .message {
        max-width: 95%;
    }
}

.model-badge {
    font-size: 0.7rem;
    padding: 0.2rem 0.5rem;
}

.source-card {
    border-left: 3px solid #007bff;
    background: #f8f9fa;
    padding: 0.5rem;
    margin: 0.25rem 0;
    border-radius: 0.25rem;
    font-size: 0.85rem;
}

[data-bs-theme="dark"] .source-card {
    background: #343a40;
    border-left-color: #0d6efd;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid h-100">
    <div class="row h-100">
        <!-- Chat Panel -->
        <div class="col-lg-8 col-md-7">
            <div class="card shadow-sm h-100 chat-container">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-comments me-2"></i>
                        <h5 class="mb-0">Chat RAG</h5>
                        <span class="badge bg-light text-primary ms-2" id="chat-mode">
                            <i class="fas fa-robot me-1"></i>Individual
                        </span>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-light btn-sm" id="toggle-comparison" 
                                title="Alternar modo comparación">
                            <i class="fas fa-balance-scale"></i>
                        </button>
                        <button class="btn btn-outline-light btn-sm" id="clear-chat" 
                                title="Limpiar chat">
                            <i class="fas fa-broom"></i>
                        </button>
                        <button class="btn btn-outline-light btn-sm" id="export-chat" 
                                title="Exportar chat">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>
                
                <div class="card-body p-0 d-flex flex-column">
                    <!-- Messages Area -->
                    <div class="messages-container p-3" id="messages-container">
                        <div class="text-center text-muted py-4" id="welcome-message">
                            <i class="fas fa-robot fa-3x mb-3 text-primary"></i>
                            <h5>¡Bienvenido al Chat RAG!</h5>
                            <p>Haz preguntas sobre procedimientos administrativos, normativas o servicios públicos.</p>
                            <div class="d-flex flex-wrap justify-content-center gap-2 mt-3">
                                <button class="btn btn-outline-primary btn-sm" onclick="sendSampleQuery('¿Qué documentos necesito para una licencia de obra?')">
                                    Licencia de obra
                                </button>
                                <button class="btn btn-outline-primary btn-sm" onclick="sendSampleQuery('¿Cómo tramito una subvención municipal?')">
                                    Subvenciones
                                </button>
                                <button class="btn btn-outline-primary btn-sm" onclick="sendSampleQuery('¿Qué ordenanzas regulan el ruido?')">
                                    Normativas ruido
                                </button>
                            </div>
                        </div>
                        
                        <!-- Typing indicator -->
                        <div class="typing-indicator" id="typing-indicator">
                            <div class="typing-dots">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                            </div>
                            <span class="ms-2 text-muted">El asistente está escribiendo...</span>
                        </div>
                    </div>
                    
                    <!-- Input Area -->
                    <div class="card-footer bg-light">
                        <form id="chat-form" class="d-flex gap-2">
                            <div class="flex-grow-1">
                                <div class="input-group">
                                    <textarea class="form-control" id="message-input" 
                                              placeholder="Escribe tu consulta sobre administración local..."
                                              rows="2" style="resize: none;" maxlength="1000"></textarea>
                                    <button class="btn btn-primary" type="submit" id="send-button">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                                <div class="form-text d-flex justify-content-between">
                                    <span>
                                        <i class="fas fa-info-circle me-1"></i>
                                        Usa <kbd>Shift + Enter</kbd> para nueva línea
                                    </span>
                                    <span id="char-counter">0/1000</span>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Configuration Panel -->
        <div class="col-lg-4 col-md-5">
            <div class="card shadow-sm h-100">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-cog me-2"></i>
                        Configuración
                    </h6>
                </div>
                <div class="card-body">
                    <!-- Model Selection -->
                    <div class="mb-3">
                        <label for="provider-select" class="form-label">
                            <i class="fas fa-brain me-1"></i>Proveedor de Modelo
                        </label>
                        <select class="form-select" id="provider-select">
                            <option value="ollama" selected>Ollama (Local)</option>
                            <option value="openai">OpenAI (API)</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="model-select" class="form-label">Modelo Específico</label>
                        <select class="form-select" id="model-select">
                            <!-- Opciones cargadas dinámicamente -->
                        </select>
                    </div>
                    
                    <!-- RAG Configuration -->
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="use-rag" checked>
                            <label class="form-check-label" for="use-rag">
                                <i class="fas fa-search me-1"></i>Usar RAG
                            </label>
                        </div>
                        <div class="form-text">Recuperar contexto de documentos</div>
                    </div>
                    
                    <div class="mb-3" id="rag-config">
                        <label for="rag-k" class="form-label">
                            Documentos a recuperar: <span id="rag-k-value">5</span>
                        </label>
                        <input type="range" class="form-range" id="rag-k" min="1" max="10" value="5">
                    </div>
                    
                    <!-- Generation Parameters -->
                    <div class="accordion" id="advanced-config">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#generation-params">
                                    <i class="fas fa-sliders-h me-2"></i>
                                    Parámetros Avanzados
                                </button>
                            </h2>
                            <div id="generation-params" class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    <div class="mb-3">
                                        <label for="temperature" class="form-label">
                                            Temperatura: <span id="temperature-value">0.7</span>
                                        </label>
                                        <input type="range" class="form-range" id="temperature" 
                                               min="0" max="1" step="0.1" value="0.7">
                                        <div class="form-text">Controla la creatividad de las respuestas</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="max-tokens" class="form-label">Tokens máximos</label>
                                        <input type="number" class="form-control" id="max-tokens" 
                                               value="1000" min="100" max="4000">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="top-p" class="form-label">
                                            Top-p: <span id="top-p-value">0.9</span>
                                        </label>
                                        <input type="range" class="form-range" id="top-p" 
                                               min="0.1" max="1" step="0.1" value="0.9">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Status Information -->
                    <div class="mt-4">
                        <h6 class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Estado de la Sesión
                        </h6>
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">Mensajes:</small>
                            <small id="message-count">0</small>
                        </div>
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">Tokens usados:</small>
                            <small id="token-count">0</small>
                        </div>
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">Sesión:</small>
                            <small id="session-id" class="font-monospace">{{ session_id or 'Nueva' }}</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para fuentes RAG -->
<div class="modal fade" id="rag-sources-modal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-search me-2"></i>
                    Fuentes de Información Utilizadas
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="rag-sources-content">
                    <!-- Contenido cargado dinámicamente -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
class ChatInterface {
    constructor() {
        this.isComparisonMode = false;
        this.messageCount = 0;
        this.tokenCount = 0;
        this.sessionId = '{{ session_id or "" }}';
        
        this.initializeElements();
        this.setupEventListeners();
        this.loadModelOptions();
        this.loadChatHistory();
    }
    
    initializeElements() {
        this.messagesContainer = document.getElementById('messages-container');
        this.messageInput = document.getElementById('message-input');
        this.sendButton = document.getElementById('send-button');
        this.typingIndicator = document.getElementById('typing-indicator');
        this.welcomeMessage = document.getElementById('welcome-message');
        this.chatForm = document.getElementById('chat-form');
        this.charCounter = document.getElementById('char-counter');
    }
    
    setupEventListeners() {
        // Form submission
        this.chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            this.sendMessage();
        });
        
        // Keyboard shortcuts
        this.messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendMessage();
            }
        });
        
        // Character counter
        this.messageInput.addEventListener('input', () => {
            const length = this.messageInput.value.length;
            this.charCounter.textContent = `${length}/1000`;
            
            if (length > 900) {
                this.charCounter.classList.add('text-warning');
            } else {
                this.charCounter.classList.remove('text-warning');
            }
        });
        
        // Range inputs updates
        document.querySelectorAll('input[type="range"]').forEach(input => {
            input.addEventListener('input', (e) => {
                const valueSpan = document.getElementById(e.target.id + '-value');
                if (valueSpan) {
                    valueSpan.textContent = e.target.value;
                }
            });
        });
        
        // Provider change
        document.getElementById('provider-select').addEventListener('change', () => {
            this.loadModelOptions();
        });
        
        // RAG toggle
        document.getElementById('use-rag').addEventListener('change', (e) => {
            document.getElementById('rag-config').style.display = e.target.checked ? 'block' : 'none';
        });
        
        // Button events
        document.getElementById('toggle-comparison').addEventListener('click', () => {
            this.toggleComparisonMode();
        });
        
        document.getElementById('clear-chat').addEventListener('click', () => {
            this.clearChat();
        });
        
        document.getElementById('export-chat').addEventListener('click', () => {
            this.exportChat();
        });
    }
    
    async loadModelOptions() {
        try {
            const response = await fetch('/api/models');
            const data = await response.json();
            
            const provider = document.getElementById('provider-select').value;
            const modelSelect = document.getElementById('model-select');
            
            modelSelect.innerHTML = '';
            
            const models = data.models[provider] || [];
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                modelSelect.appendChild(option);
            });
            
            // Set default
            if (provider === 'ollama' && models.includes('{{ config.model.local_default }}')) {
                modelSelect.value = '{{ config.model.local_default }}';
            } else if (provider === 'openai' && models.includes('{{ config.model.openai_default }}')) {
                modelSelect.value = '{{ config.model.openai_default }}';
            }
            
        } catch (error) {
            console.error('Error cargando modelos:', error);
            this.showToast('Error cargando modelos disponibles', 'error');
        }
    }
    
    async loadChatHistory() {
        try {
            const response = await fetch('/chat/history');
            const data = await response.json();
            
            this.sessionId = data.session_id;
            document.getElementById('session-id').textContent = this.sessionId.substring(0, 8);
            
            if (data.messages && data.messages.length > 0) {
                this.welcomeMessage.style.display = 'none';
                
                data.messages.forEach(message => {
                    this.addMessageToUI(message);
                });
                
                this.messageCount = data.messages.length;
                this.updateSessionInfo();
                this.scrollToBottom();
            }
            
        } catch (error) {
            console.error('Error cargando historial:', error);
        }
    }
    
    async sendMessage() {
        const message = this.messageInput.value.trim();
        if (!message) return;
        
        // Validate message length
        if (message.length > 1000) {
            this.showToast('Mensaje demasiado largo (máximo 1000 caracteres)', 'error');
            return;
        }
        
        // Disable input
        this.setInputState(false);
        
        // Add user message to UI
        const userMessage = {
            role: 'user',
            content: message,
            timestamp: new Date().toISOString()
        };
        this.addMessageToUI(userMessage);
        
        // Clear input
        this.messageInput.value = '';
        this.charCounter.textContent = '0/1000';
        
        // Hide welcome message
        this.welcomeMessage.style.display = 'none';
        
        // Show typing indicator
        this.showTypingIndicator();
        
        try {
            if (this.isComparisonMode) {
                await this.sendComparisonRequest(message);
            } else {
                await this.sendSingleRequest(message);
            }
        } catch (error) {
            console.error('Error enviando mensaje:', error);
            this.showToast('Error enviando mensaje', 'error');
        } finally {
            this.hideTypingIndicator();
            this.setInputState(true);
            this.messageInput.focus();
        }
    }
    
    async sendSingleRequest(message) {
        const requestData = {
            message: message,
            provider: document.getElementById('provider-select').value,
            model_name: document.getElementById('model-select').value,
            use_rag: document.getElementById('use-rag').checked,
            rag_k: parseInt(document.getElementById('rag-k').value),
            temperature: parseFloat(document.getElementById('temperature').value),
            max_tokens: parseInt(document.getElementById('max-tokens').value),
            top_p: parseFloat(document.getElementById('top-p').value)
        };
        
        const response = await fetch('/chat/message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            const assistantMessage = {
                role: 'assistant',
                content: data.content,
                model_name: data.model.name,
                model_type: data.model.type,
                response_time: data.model.response_time,
                tokens_used: data.model.tokens_used,
                rag_sources: data.rag.sources,
                timestamp: new Date().toISOString()
            };
            
            this.addMessageToUI(assistantMessage);
            this.updateTokenCount(data.model.tokens_used || 0);
        } else {
            this.addErrorMessage(data.error || 'Error procesando la consulta');
        }
    }
    
    async sendComparisonRequest(message) {
        const requestData = {
            message: message,
            use_rag: document.getElementById('use-rag').checked,
            rag_k: parseInt(document.getElementById('rag-k').value),
            temperature: parseFloat(document.getElementById('temperature').value),
            max_tokens: parseInt(document.getElementById('max-tokens').value),
            top_p: parseFloat(document.getElementById('top-p').value)
        };
        
        const response = await fetch('/chat/compare', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        const data = await response.json();
        
        // Add comparison results to UI
        this.addComparisonToUI(data);
        
        // Update token count
        const totalTokens = Object.values(data.responses).reduce((sum, resp) => {
            return sum + (resp.tokens_used || 0);
        }, 0);
        this.updateTokenCount(totalTokens);
    }
    
    addMessageToUI(message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${message.role}`;
        
        let badgeHtml = '';
        if (message.model_name) {
            const badgeClass = message.model_type === 'local' ? 'bg-success' : 'bg-info';
            badgeHtml = `<span class="badge ${badgeClass} model-badge">${message.model_name}</span>`;
        }
        
        let ragSourcesHtml = '';
        if (message.rag_sources && message.rag_sources.length > 0) {
            ragSourcesHtml = `
                <button class="btn btn-link btn-sm p-0 mt-1" onclick="showRagSources('${message.id || Date.now()}')">
                    <i class="fas fa-search me-1"></i>
                    Ver fuentes (${message.rag_sources.length})
                </button>
            `;
            
            // Store sources for modal
            window.ragSources = window.ragSources || {};
            window.ragSources[message.id || Date.now()] = message.rag_sources;
        }
        
        const metadataHtml = message.role === 'assistant' ? `
            <div class="message-metadata">
                ${badgeHtml}
                ${message.response_time ? `<small class="ms-2">⏱️ ${message.response_time.toFixed(2)}s</small>` : ''}
                ${message.tokens_used ? `<small class="ms-2">🔤 ${message.tokens_used} tokens</small>` : ''}
                ${ragSourcesHtml}
            </div>
        ` : '';
        
        messageDiv.innerHTML = `
            <div class="message-content">
                ${this.formatMessageContent(message.content)}
            </div>
            ${metadataHtml}
        `;
        
        this.messagesContainer.appendChild(messageDiv);
        this.scrollToBottom();
        this.messageCount++;
        this.updateSessionInfo();
    }
    
    addComparisonToUI(data) {
        const comparisonDiv = document.createElement('div');
        comparisonDiv.className = 'message assistant';
        
        let responsesHtml = '<div class="comparison-container">';
        
        Object.entries(data.responses).forEach(([provider, response]) => {
            const badgeClass = provider === 'ollama' ? 'bg-success' : 'bg-info';
            const statusClass = response.success ? 'border-success' : 'border-danger';
            
            responsesHtml += `
                <div class="card ${statusClass}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span class="badge ${badgeClass}">${response.model_name}</span>
                        ${response.response_time ? `<small>⏱️ ${response.response_time.toFixed(2)}s</small>` : ''}
                    </div>
                    <div class="card-body">
                        ${response.success ? 
                            this.formatMessageContent(response.content) : 
                            `<div class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>${response.error}</div>`
                        }
                    </div>
                    ${response.tokens_used ? `<div class="card-footer"><small>🔤 ${response.tokens_used} tokens</small></div>` : ''}
                </div>
            `;
        });
        
        responsesHtml += '</div>';
        
        // Add comparison metadata
        const metadataHtml = `
            <div class="message-metadata mt-2">
                <span class="badge bg-secondary">Comparación</span>
                <small class="ms-2">⏱️ ${data.comparison.total_time.toFixed(2)}s total</small>
                <small class="ms-2">✅ ${data.comparison.successful_responses}/${data.comparison.providers_compared} exitosos</small>
                ${data.rag.enabled ? `<small class="ms-2">📄 ${data.rag.sources_count} fuentes</small>` : ''}
            </div>
        `;
        
        comparisonDiv.innerHTML = `
            <div class="message-content">
                <strong><i class="fas fa-balance-scale me-2"></i>Comparación de Modelos</strong>
                ${responsesHtml}
            </div>
            ${metadataHtml}
        `;
        
        this.messagesContainer.appendChild(comparisonDiv);
        this.scrollToBottom();
        this.messageCount++;
        this.updateSessionInfo();
    }
    
    addErrorMessage(error) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'message assistant';
        errorDiv.innerHTML = `
            <div class="message-content">
                <div class="text-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Error:</strong> ${error}
                </div>
            </div>
        `;
        
        this.messagesContainer.appendChild(errorDiv);
        this.scrollToBottom();
    }
    
    formatMessageContent(content) {
        // Basic formatting - en producción usar markdown parser
        return content
            .replace(/\n/g, '<br>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/`(.*?)`/g, '<code>$1</code>');
    }
    
    showTypingIndicator() {
        this.typingIndicator.style.display = 'flex';
        this.scrollToBottom();
    }
    
    hideTypingIndicator() {
        this.typingIndicator.style.display = 'none';
    }
    
    setInputState(enabled) {
        this.messageInput.disabled = !enabled;
        this.sendButton.disabled = !enabled;
        
        if (enabled) {
            this.sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
        } else {
            this.sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        }
    }
    
    scrollToBottom() {
        setTimeout(() => {
            this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
        }, 100);
    }
    
    updateSessionInfo() {
        document.getElementById('message-count').textContent = this.messageCount;
    }
    
    updateTokenCount(tokens) {
        this.tokenCount += tokens;
        document.getElementById('token-count').textContent = this.tokenCount;
    }
    
    toggleComparisonMode() {
        this.isComparisonMode = !this.isComparisonMode;
        const modeSpan = document.getElementById('chat-mode');
        const toggleButton = document.getElementById('toggle-comparison');
        
        if (this.isComparisonMode) {
            modeSpan.innerHTML = '<i class="fas fa-balance-scale me-1"></i>Comparación';
            modeSpan.className = 'badge bg-warning text-dark ms-2';
            toggleButton.classList.add('active');
        } else {
            modeSpan.innerHTML = '<i class="fas fa-robot me-1"></i>Individual';
            modeSpan.className = 'badge bg-light text-primary ms-2';
            toggleButton.classList.remove('active');
        }
        
        this.showToast(`Modo ${this.isComparisonMode ? 'comparación' : 'individual'} activado`, 'info');
    }
    
    async clearChat() {
        if (!confirm('¿Estás seguro de que quieres limpiar el chat?')) return;
        
        try {
            const response = await fetch('/chat/clear', { method: 'POST' });
            const data = await response.json();
            
            if (data.success) {
                this.messagesContainer.innerHTML = '';
                this.welcomeMessage.style.display = 'block';
                this.messageCount = 0;
                this.tokenCount = 0;
                this.updateSessionInfo();
                this.updateTokenCount(0);
                this.showToast('Chat limpiado exitosamente', 'success');
            }
        } catch (error) {
            console.error('Error limpiando chat:', error);
            this.showToast('Error limpiando el chat', 'error');
        }
    }
    
    async exportChat() {
        try {
            const response = await fetch('/chat/export');
            const data = await response.json();
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat-export-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            this.showToast('Chat exportado exitosamente', 'success');
        } catch (error) {
            console.error('Error exportando chat:', error);
            this.showToast('Error exportando el chat', 'error');
        }
    }
    
    showToast(message, type = 'info') {
        const toastContainer = document.querySelector('.toast-container');
        const toastId = 'toast-' + Date.now();
        
        const toastHtml = `
            <div class="toast" id="${toastId}" role="alert">
                <div class="toast-header">
                    <i class="fas fa-${type === 'error' ? 'exclamation-triangle text-danger' : 
                                      type === 'success' ? 'check-circle text-success' : 
                                      'info-circle text-info'} me-2"></i>
                    <strong class="me-auto">Chat</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">${message}</div>
            </div>
        `;
        
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        
        const toast = new bootstrap.Toast(document.getElementById(toastId));
        toast.show();
        
        // Remove from DOM after hide
        document.getElementById(toastId).addEventListener('hidden.bs.toast', () => {
            document.getElementById(toastId).remove();
        });
    }
}

// Global functions
function sendSampleQuery(query) {
    document.getElementById('message-input').value = query;
    chatInterface.sendMessage();
}

function showRagSources(messageId) {
    const sources = window.ragSources[messageId];
    if (!sources) return;
    
    let sourcesHtml = '';
    sources.forEach((source, index) => {
        sourcesHtml += `
            <div class="source-card">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <strong class="text-primary">Fuente ${index + 1}</strong>
                    <span class="badge bg-secondary">${source.source_type}</span>
                </div>
                <div class="mb-2">
                    <small class="text-muted">
                        <i class="fas fa-file me-1"></i>${source.source_path}
                        ${source.section_title ? ` - ${source.section_title}` : ''}
                    </small>
                </div>
                <div class="text-muted">${source.content}</div>
            </div>
        `;
    });
    
    document.getElementById('rag-sources-content').innerHTML = sourcesHtml;
    
    const modal = new bootstrap.Modal(document.getElementById('rag-sources-modal'));
    modal.show();
}

// Initialize chat interface
let chatInterface;
document.addEventListener('DOMContentLoaded', function() {
    chatInterface = new ChatInterface();
});
</script>
{% endblock %}