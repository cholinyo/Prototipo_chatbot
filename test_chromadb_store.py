#!/usr/bin/env python3
"""
Script de prueba para ChromaDBVectorStore
Prototipo_chatbot - TFM Vicente Caruncho
"""

import sys
import os
import time
import numpy as np
from pathlib import Path
from datetime import datetime

# A√±adir el directorio ra√≠z al path
project_root = Path(__file__).parent
sys.path.insert(0, str(project_root))

def test_chromadb_dependencies():
    """Verificar dependencias de ChromaDB"""
    print("üîç Verificando dependencias ChromaDB...")
    
    try:
        import chromadb
        print(f"   ‚úÖ chromadb: {chromadb.__version__ if hasattr(chromadb, '__version__') else 'instalado'}")
    except ImportError:
        print("   ‚ùå chromadb: No instalado")
        print("   üí° Instalar con: pip install chromadb")
        return False
    
    try:
        import numpy as np
        print(f"   ‚úÖ numpy: {np.__version__}")
    except ImportError:
        print("   ‚ùå numpy: No instalado")
        return False
    
    return True

def test_chromadb_vector_store():
    """Prueba completa del ChromaDBVectorStore"""
    print("üöÄ Iniciando prueba del ChromaDBVectorStore...")
    print("=" * 60)
    
    try:
        print("üì¶ 1. Importando m√≥dulos...")
        
        from app.services.rag.chromadb_store import (
            ChromaDBVectorStore, 
            ChromaDBMetrics,
            create_chromadb_store,
            is_chromadb_available
        )
        from app.services.rag.embeddings import embedding_service
        from app.models import DocumentChunk, DocumentMetadata
        
        print("   ‚úÖ M√≥dulos importados correctamente")
        
    except ImportError as e:
        print(f"   ‚ùå Error importando: {e}")
        return False
    
    try:
        print("\nüîß 2. Verificando disponibilidad...")
        
        # Verificar que ChromaDB est√© disponible
        if not is_chromadb_available():
            print("   ‚ùå ChromaDB no disponible")
            return False
        
        print("   ‚úÖ ChromaDB disponible")
        
        # Verificar que EmbeddingService est√© disponible
        if not embedding_service.is_available():
            print("   ‚ùå EmbeddingService no disponible")
            return False
        
        print("   ‚úÖ EmbeddingService disponible")
        
    except Exception as e:
        print(f"   ‚ùå Error verificando servicios: {e}")
        return False
    
    try:
        print("\nüèóÔ∏è 3. Creando ChromaDBVectorStore de prueba...")
        
        # Crear store en directorio temporal
        test_store_path = "data/test_chromadb"
        store = create_chromadb_store(
            store_path=test_store_path,
            collection_name="test_collection",
            distance_function="cosine"
        )
        
        print(f"   ‚úÖ Store creado en: {test_store_path}")
        
        # Verificar estado inicial
        stats = store.get_stats()
        print(f"   ‚úÖ Documentos iniciales: {stats.get('total_documents', 0)}")
        print(f"   ‚úÖ Funci√≥n de distancia: {stats.get('distance_function', 'unknown')}")
        print(f"   ‚úÖ Colecci√≥n: {stats.get('collection_name', 'unknown')}")
        
    except Exception as e:
        print(f"   ‚ùå Error creando store: {e}")
        return False
    
    try:
        print("\nüìù 4. Creando documentos de prueba...")
        
        # Crear metadatos de prueba
        test_metadata = DocumentMetadata(
            source_path="test_document_chromadb.pdf",
            source_type="document",
            file_type=".pdf",
            size_bytes=2048,
            created_at=datetime.now(),
            processed_at=datetime.now(),
            checksum="test_checksum_chromadb"
        )
        
        # Crear chunks de prueba (diferentes a FAISS para comparaci√≥n)
        test_texts = [
            "Normativas y reglamentos municipales de la administraci√≥n local",
            "Procedimientos administrativos para licencias y permisos",
            "Gesti√≥n de expedientes y tr√°mites ciudadanos",
            "Servicios p√∫blicos municipales y atenci√≥n al p√∫blico",
            "Ordenanzas locales y regulaciones municipales",
            "Hacienda p√∫blica y gesti√≥n presupuestaria municipal",
            "Planificaci√≥n urbana y gesti√≥n territorial",
            "Pol√≠ticas sociales y servicios de bienestar ciudadano",
            "Medio ambiente y sostenibilidad municipal",
            "Transparencia y participaci√≥n ciudadana"
        ]
        
        test_chunks = []
        for i, text in enumerate(test_texts):
            chunk = DocumentChunk(
                id=f"chromadb-test-chunk-{i+1}",
                content=text,
                metadata=test_metadata,
                chunk_index=i,
                chunk_size=len(text),
                start_char=i*120,
                end_char=(i+1)*120
            )
            test_chunks.append(chunk)
        
        print(f"   ‚úÖ {len(test_chunks)} chunks creados")
        
    except Exception as e:
        print(f"   ‚ùå Error creando documentos: {e}")
        return False
    
    try:
        print("\nüß† 5. Generando embeddings...")
        
        # Generar embeddings usando EmbeddingService
        start_time = time.time()
        embedded_chunks = embedding_service.encode_documents(test_chunks)
        embedding_time = time.time() - start_time
        
        print(f"   ‚úÖ Embeddings generados en {embedding_time:.3f}s")
        print(f"   ‚úÖ Chunks con embeddings: {len(embedded_chunks)}")
        
        # Verificar que tienen embeddings
        for i, chunk in enumerate(embedded_chunks[:3]):
            print(f"   ‚úÖ Chunk {i+1}: embedding shape {np.array(chunk.embedding).shape}")
        
    except Exception as e:
        print(f"   ‚ùå Error generando embeddings: {e}")
        return False
    
    try:
        print("\nüíæ 6. A√±adiendo documentos a ChromaDB...")
        
        # A√±adir documentos al store
        start_time = time.time()
        success = store.add_documents(embedded_chunks)
        add_time = time.time() - start_time
        
        if not success:
            print("   ‚ùå Error a√±adiendo documentos")
            return False
        
        print(f"   ‚úÖ Documentos a√±adidos en {add_time:.3f}s")
        
        # Verificar estado despu√©s de a√±adir
        stats = store.get_stats()
        print(f"   ‚úÖ Total documentos: {stats.get('total_documents', 0)}")
        print(f"   ‚úÖ Uso de disco: {stats.get('disk_usage_mb', 0):.2f} MB")
        
        # Verificar distribuci√≥n por tipo
        metrics_dict = stats.get('metrics', {})
        source_dist = metrics_dict.get('source_distribution', {})
        print(f"   ‚úÖ Distribuci√≥n por tipo: {source_dist}")
        
    except Exception as e:
        print(f"   ‚ùå Error a√±adiendo documentos: {e}")
        return False
    
    try:
        print("\nüîç 7. Probando b√∫squedas...")
        
        # Test b√∫squeda b√°sica
        query_text = "procedimientos administrativos municipales"
        query_embedding = embedding_service.encode_single_text(query_text)
        
        start_time = time.time()
        results = store.search(query_embedding, k=3)
        search_time = time.time() - start_time
        
        print(f"   ‚úÖ B√∫squeda completada en {search_time:.3f}s")
        print(f"   ‚úÖ Resultados encontrados: {len(results)}")
        
        # Mostrar resultados
        for i, (chunk, score) in enumerate(results):
            print(f"   üìÑ Resultado {i+1}: score={score:.3f}")
            print(f"       Texto: {chunk.content[:50]}...")
            print(f"       ID: {chunk.id}")
        
    except Exception as e:
        print(f"   ‚ùå Error en b√∫squedas: {e}")
        return False
    
    try:
        print("\nüéØ 8. Probando filtros...")
        
        # Test b√∫squeda con filtros
        filters = {'source_type': 'document'}
        
        start_time = time.time()
        filtered_results = store.search(query_embedding, k=3, filters=filters)
        filtered_search_time = time.time() - start_time
        
        print(f"   ‚úÖ B√∫squeda filtrada en {filtered_search_time:.3f}s")
        print(f"   ‚úÖ Resultados filtrados: {len(filtered_results)}")
        
        # Verificar que los filtros funcionan
        for chunk, score in filtered_results:
            assert chunk.metadata.source_type == 'document', "Filtro no aplicado correctamente"
        
        print("   ‚úÖ Filtros funcionando correctamente")
        
    except Exception as e:
        print(f"   ‚ùå Error en filtros: {e}")
        return False
    
    try:
        print("\nüìä 9. Probando m√©tricas y benchmarking...")
        
        # Obtener estad√≠sticas detalladas
        stats = store.get_stats()
        metrics = stats.get('metrics', {})
        
        print("   ‚úÖ M√©tricas de rendimiento:")
        print(f"      - Tiempo promedio add: {metrics.get('avg_add_time', 0):.3f}s")
        print(f"      - Tiempo promedio search: {metrics.get('avg_search_time', 0):.3f}s")
        print(f"      - Total operaciones add: {metrics.get('total_add_operations', 0)}")
        print(f"      - Total operaciones search: {metrics.get('total_search_operations', 0)}")
        print(f"      - Uso de disco: {stats.get('disk_usage_mb', 0):.2f} MB")
        
    except Exception as e:
        print(f"   ‚ùå Error obteniendo m√©tricas: {e}")
        return False
    
    try:
        print("\nüíæ 10. Probando persistencia...")
        
        # Crear nuevo store apuntando al mismo directorio
        store2 = ChromaDBVectorStore(
            store_path=test_store_path,
            collection_name="test_collection"
        )
        
        # Verificar que carg√≥ los datos
        stats2 = store2.get_stats()
        print(f"   ‚úÖ Store2 cargado con {stats2.get('total_documents', 0)} documentos")
        
        # Verificar que puede buscar
        results2 = store2.search(query_embedding, k=2)
        print(f"   ‚úÖ Store2 b√∫squeda: {len(results2)} resultados")
        
        # Verificar que los resultados son consistentes
        if len(results) > 0 and len(results2) > 0:
            # Los IDs pueden variar, pero el contenido deber√≠a ser similar
            print("   ‚úÖ Persistencia funcionando correctamente")
        
    except Exception as e:
        print(f"   ‚ùå Error en persistencia: {e}")
        return False
    
    try:
        print("\nüîç 11. Probando informaci√≥n de colecci√≥n...")
        
        # Obtener informaci√≥n detallada
        collection_info = store.get_collection_info()
        
        print("   ‚úÖ Informaci√≥n de colecci√≥n:")
        print(f"      - Nombre: {collection_info.get('name', 'unknown')}")
        print(f"      - Documentos: {collection_info.get('count', 0)}")
        print(f"      - Metadatos: {collection_info.get('metadata', {})}")
        
        # Mostrar muestra de documentos
        sample = collection_info.get('sample_documents', {})
        if sample.get('ids'):
            print(f"      - Documentos de muestra: {len(sample['ids'])}")
            for i, doc_id in enumerate(sample['ids'][:2]):
                print(f"        ‚Ä¢ {doc_id}: {sample['documents'][i][:50]}...")
        
    except Exception as e:
        print(f"   ‚ùå Error obteniendo info de colecci√≥n: {e}")
        return False
    
    try:
        print("\nüß™ 12. Test de rendimiento comparativo...")
        
        # Test de rendimiento con m√°s documentos
        performance_chunks = []
        for i in range(30):
            chunk = DocumentChunk(
                id=f"chromadb-perf-chunk-{i}",
                content=f"Documento de rendimiento ChromaDB n√∫mero {i} con contenido variado para testing y comparaci√≥n",
                metadata=test_metadata,
                chunk_index=i,
                chunk_size=90,
                start_char=i*120,
                end_char=(i+1)*120
            )
            performance_chunks.append(chunk)
        
        # Generar embeddings
        perf_embedded = embedding_service.encode_documents(performance_chunks)
        
        # A√±adir al store
        start_time = time.time()
        store.add_documents(perf_embedded)
        batch_add_time = time.time() - start_time
        
        print(f"   ‚úÖ {len(performance_chunks)} docs a√±adidos en {batch_add_time:.3f}s")
        print(f"   ‚úÖ Throughput: {len(performance_chunks)/batch_add_time:.1f} docs/segundo")
        
        # Test de b√∫squedas m√∫ltiples
        queries = ["documento", "rendimiento", "testing", "comparaci√≥n", "chromadb"]
        total_search_time = 0
        
        for query in queries:
            query_emb = embedding_service.encode_single_text(query)
            start_time = time.time()
            _ = store.search(query_emb, k=5)
            total_search_time += time.time() - start_time
        
        avg_search = total_search_time / len(queries)
        print(f"   ‚úÖ Tiempo promedio b√∫squeda: {avg_search:.3f}s")
        
    except Exception as e:
        print(f"   ‚ùå Error en test de rendimiento: {e}")
        return False
    
    print("\nüéâ ¬°Todos los tests de ChromaDBVectorStore completados exitosamente!")
    print("=" * 60)
    
    # Resumen final
    final_stats = store.get_stats()
    print("\nüìä RESUMEN FINAL CHROMADB:")
    print(f"‚úÖ Tipo: {final_stats.get('type', 'unknown')}")
    print(f"‚úÖ Total documentos: {final_stats.get('total_documents', 0)}")
    print(f"‚úÖ Colecci√≥n: {final_stats.get('collection_name', 'unknown')}")
    print(f"‚úÖ Funci√≥n distancia: {final_stats.get('distance_function', 'unknown')}")
    print(f"‚úÖ Uso de disco: {final_stats.get('disk_usage_mb', 0):.2f} MB")
    
    metrics = final_stats.get('metrics', {})
    print(f"‚úÖ Operaciones add: {metrics.get('total_add_operations', 0)}")
    print(f"‚úÖ Operaciones search: {metrics.get('total_search_operations', 0)}")
    print(f"‚úÖ Tiempo promedio add: {metrics.get('avg_add_time', 0):.3f}s")
    print(f"‚úÖ Tiempo promedio search: {metrics.get('avg_search_time', 0):.3f}s")
    
    print("\nüéØ ChromaDBVectorStore listo para comparaci√≥n con FAISS!")
    return True


def cleanup_test_data():
    """Limpiar datos de prueba"""
    import shutil
    test_dir = Path("data/test_chromadb")
    if test_dir.exists():
        try:
            shutil.rmtree(test_dir)
            print("üßπ Datos de prueba ChromaDB limpiados")
        except Exception as e:
            print(f"‚ö†Ô∏è  Error limpiando ChromaDB: {e}")


def compare_with_faiss():
    """Mostrar comparaci√≥n r√°pida con FAISS"""
    print("\n" + "=" * 60)
    print("üìä COMPARACI√ìN R√ÅPIDA FAISS vs CHROMADB")
    print("=" * 60)
    
    try:
        # Datos de FAISS (de test anterior)
        print("üîµ FAISS:")
        print("   ‚Ä¢ Tipo: IndexFlatL2")
        print("   ‚Ä¢ Memoria: ~0.08 MB")
        print("   ‚Ä¢ B√∫squeda: ~0.003s")
        print("   ‚Ä¢ Almacenamiento: En memoria + archivos pickle")
        print("   ‚Ä¢ Ventajas: Muy r√°pido, optimizado para similitud")
        
        print("\nüü¢ ChromaDB:")
        print("   ‚Ä¢ Tipo: Cosine distance")
        print("   ‚Ä¢ Almacenamiento: Base de datos persistente")
        print("   ‚Ä¢ B√∫squeda: Variable seg√∫n configuraci√≥n")
        print("   ‚Ä¢ Ventajas: Persistencia autom√°tica, metadatos ricos")
        
        print("\nüéØ Para tu TFM:")
        print("   ‚Ä¢ FAISS: Mejor para velocidad pura")
        print("   ‚Ä¢ ChromaDB: Mejor para casos de uso complejos")
        print("   ‚Ä¢ Ambos: Excelente base para comparaci√≥n acad√©mica")
        
    except Exception as e:
        print(f"Error en comparaci√≥n: {e}")


if __name__ == "__main__":
    print("üß™ Test del ChromaDBVectorStore - Prototipo_chatbot")
    print("=" * 60)
    
    # Verificar dependencias primero
    if not test_chromadb_dependencies():
        print("\nüíî No se pueden ejecutar los tests sin las dependencias")
        print("üí° Instalar con: pip install chromadb")
        sys.exit(1)
    
    # Ejecutar tests
    try:
        success = test_chromadb_vector_store()
        
        if success:
            print("\nüéâ ¬°TESTS DE CHROMADB COMPLETADOS EXITOSAMENTE!")
            compare_with_faiss()
            print("\nüëâ ¬°Listo para implementar comparaci√≥n completa FAISS vs ChromaDB!")
            cleanup_test_data()
            sys.exit(0)
        else:
            print("\nüíî Algunos tests de ChromaDB fallaron")
            sys.exit(1)
            
    except KeyboardInterrupt:
        print("\n‚èπÔ∏è  Tests interrumpidos por el usuario")
        cleanup_test_data()
        sys.exit(1)
    except Exception as e:
        print(f"\nüí• Error inesperado en tests de ChromaDB: {e}")
        cleanup_test_data()
        sys.exit(1)